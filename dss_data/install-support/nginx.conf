
# This file is automatically generated. Manual edits will be lost upon DSS updates.

error_log stderr;
pid "/data/dataiku/dss_data/run/nginx/nginx.pid";
daemon off;
working_directory "/data/dataiku/dss_data/run/nginx";

events {
    worker_connections 10000;
}

http {
    # make these variables have a default value, they're used in some dynamically added locations
    map $auth_studiourl $auth_studiourl {}
    map $auth_accessforbiddenreason $auth_accessforbiddenreason {}

    gzip on;
    gzip_types text/javascript application/json text/css image/svg+xml;
    client_max_body_size 0;
    large_client_header_buffers 8 256K;
    server_tokens off;

    types {
        text/html       html htm shtml;
        text/css        css;
        text/javascript js;
        text/css        less;
        audio/mpeg      mp3;
        image/svg+xml   svg;
        application/pdf pdf;
    }

    access_log "/data/dataiku/dss_data/run/nginx/access.log";
    client_body_temp_path "/data/dataiku/dss_data/run/nginx";
    proxy_temp_path "/data/dataiku/dss_data/run/nginx";
    # Define these even if we don't use them to avoid permission issues
    fastcgi_temp_path "/data/dataiku/dss_data/run/nginx";
    scgi_temp_path "/data/dataiku/dss_data/run/nginx";
    uwsgi_temp_path "/data/dataiku/dss_data/run/nginx";

    proxy_http_version 1.1;
    proxy_next_upstream off; # Don't retry
    proxy_read_timeout 3600; # We have long queries
    proxy_set_header Host $http_host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header x-dss-nginx-client-ip $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    server {
        listen 10000;

        root "/opt/dataiku-dss-13.1.2/frontend";

        include "/data/dataiku/dss_data/install-support/python-backends.d/*.conf"; #legacy location
        include "/data/dataiku/dss_data/install-support/backends.d/*/*.conf";

        

        location ^~ /dip/ {
            proxy_pass http://127.0.0.1:10001/dip/;
            
            
        }
        location ^~ /public/packages/ {
            alias "/opt/dataiku-dss-13.1.2/public/packages/";
        }
        location /public/packages/dataiku-scoring-libs.jar {
            proxy_pass http://127.0.0.1:10001/dip/publicapi/resources/scoring-lib-jar/;
        }
        location ^~ /public/api/ {
            proxy_pass http://127.0.0.1:10001/dip/publicapi/;
        }
        location ^~ /jupyter/ {
            proxy_pass http://127.0.0.1:10002/jupyter/;
            proxy_redirect off;
            proxy_read_timeout 600;
            proxy_send_timeout 600;
        }

        

        location ~ ^/plugins/([^/]+)/resource/(.*)$ {
            root /;
            try_files /data/dataiku/dss_data/plugins/installed/$1/resource/$2 /data/dataiku/dss_data/plugins/dev/$1/resource/$2
            
            add_header Cache-Control private;
            expires 0;
            location ~ ^/plugins/([^/]+)/resource/(.*\.(html|css|js))$ {
                try_files /data/dataiku/dss_data/plugins/installed/$1/resource/$2 /data/dataiku/dss_data/plugins/dev/$1/resource/$2
                
                add_header Cache-Control private;
                expires -1;    # Equivalent to cache-control: no-cache
            }
        }

        
        location = /local/projects/auth {
            proxy_pass http://127.0.0.1:10001/dip/api/projects/$dku_project_key/check-access;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Sec-WebSocket-Protocol "";
            proxy_set_header X-Original-URI $request_uri;
        }

        location @error_location_local_project_static {
            try_files /local-projects-static-error-401.html /local-projects-static-error-401.html;
            sub_filter "http://localhost:10000" $auth_studiourl;
            sub_filter_once on;
        }
        location @reject_location_local_project_static {
            try_files /local-projects-static-error-403.html /local-projects-static-error-403.html;
            sub_filter "http://localhost:10000" $auth_studiourl;
            sub_filter "ERROR_MESSAGE_PLACEHOLDER" $auth_accessforbiddenreason;
            sub_filter_once on;
        }

        location ~ ^/local/projects/([^/]+)/static/(.*)$ {
            alias "/data/dataiku/dss_data/config/projects/$1/lib/static/$2";
            
            add_header Cache-Control private;
            expires -1;    # Equivalent to cache-control: no-cache
            set $dku_project_key $1; # because you can't have variables in the auth_request directive
            auth_request "/local/projects/auth";
            auth_request_set $auth_studiourl $upstream_http_x_dku_studiourl;
            auth_request_set $auth_accessforbiddenreason $upstream_http_x_dku_accessforbiddenreason;
            error_page 502 /local-projects-static-error-502.html;
            error_page 401 @error_location_local_project_static;
            error_page 403 @reject_location_local_project_static;
        }

        location ~ ^/local/projects/([^/]+)/resources/(.*)$ {
            alias "/data/dataiku/dss_data/lib/projects/$1/static/$2";
            
            add_header Cache-Control private;
            expires -1;    # Equivalent to cache-control: no-cache
            set $dku_project_key $1; # because you can't have variables in the auth_request directive
            auth_request "/local/projects/auth";
            auth_request_set $auth_studiourl $upstream_http_x_dku_studiourl;
            auth_request_set $auth_accessforbiddenreason $upstream_http_x_dku_accessforbiddenreason;
            error_page 502 /local-projects-static-error-502.html;
            error_page 401 @error_location_local_project_static;
            error_page 403 @reject_location_local_project_static;
        }

        location ~ ^/local/projects/([^/]+)/public-resources/(.*)$ {
            alias "/data/dataiku/dss_data/lib/projects/$1/local-static/$2";
        }


        


        location / {
            rewrite ^/(home|profile|project-list|projects|workspaces|wikis|login|logged-out|sso-error|sso|admin|apps|plugins-explore|plugins|libedition|feature-store|search-dss-items|data-catalog|catalog|inbox|automation|deployer|api-deployer|project-deployer|unified-monitoring|alation-open|external-table|meanings|licensing|data-quality).*$ /index.html break;
            index index.html;
            add_header Cache-Control "private, no-cache, max-age=0";
            expires 0;
            
                  add_header "Permissions-Policy" "fullscreen=*";

            location ~ ^/themes/builtin/([^/]+)/(.*)$ {
                alias "/opt/dataiku-dss-13.1.2/resources/themes/$1/$2";
            }
            location ~ ^/themes/user/([^/]+)/(.*)$ {
                alias "/data/dataiku/dss_data/resources/themes/$1/$2";
            }
        }
        location ~ ^/ngxdist/(.*)$ {
            
                  add_header "Permissions-Policy" "fullscreen=*";

            add_header Cache-Control "private, no-cache, max-age=0";
            expires -1;    # Equivalent to cache-control: no-cache
            alias "/opt/dataiku-dss-13.1.2/frontend/ngxdist/$1";
        }
        location ~ ^/.*\.(html|css|js)$ {
            rewrite ^/(home|profile|project-list|projects|workspaces|wikis|login|logged-out|sso-error|sso|admin|apps|plugins-explore|plugins|libedition|feature-store|search-dss-items|data-catalog|inbox|automation|deployer|api-deployer|project-deployer|unified-monitoring|alation-open|external-table|meanings|licensing|data-quality).*$ /index.html break;
            index index.html;
            
                  add_header "Permissions-Policy" "fullscreen=*";

            add_header Cache-Control "private, no-cache, max-age=0";
            expires -1;    # Equivalent to cache-control: no-cache
        }
        location ^~ /local/static/ {
            alias "/data/dataiku/dss_data/local/static/";
        }
    }
}

